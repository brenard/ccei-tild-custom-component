#! /usr/bin/env python3
"""Script to emulate a CCEI Tild box"""
# pylint: disable=redefined-outer-name

import argparse
import sys

sys.path.append("/config/custom_components")

# pylint: disable=wrong-import-position
from ccei_tild.tild import IDENTIFIED_FIELDS, parse_sensors_data  # noqa: E402

parser = argparse.ArgumentParser()

parser.add_argument("data", nargs="+")
parser.add_argument("-M", "--markdown", action="store_true", help="Format output in Markdown")
parser.add_argument("-F", "--forum", action="store_true", help="Format output for the forum")

opts = parser.parse_args()


IDENTIFIED_POS = {}
for k, pos in IDENTIFIED_FIELDS.items():
    IDENTIFIED_POS.update({(p, k) for p in pos})
DIFF = {}
DIFF_KEYS = {}


def format_in_red(text):
    """Format text in red"""
    if opts.markdown:
        return f"__{text}__"
    if opts.forum:
        return f"**{text}**"
    return "\033[91m" + text + "\033[0m"


def format_diff_data(data):
    """Format data differences"""
    r = []
    for idx, char in enumerate(data):
        r.append(format_in_red(char) if idx in DIFF else char)
    r = "".join(r)
    if opts.markdown:
        r = r.replace("____", "")
    if opts.forum:
        r = r.replace("****", "")
    return r


def pretty_print_data(data):
    """Pretty format data and highlight differences"""
    r = []
    for k, v in data.items():
        line = f"{k}: {v}"
        r.append(format_in_red(line) if k in DIFF_KEYS else line)
    print("- {}".format("\n- ".join(r)))


ref_raw_data = opts.data.pop(0)
ref_data = list(ref_raw_data)
ref_parsed_data = parse_sensors_data(ref_raw_data)

if not opts.data:
    print(ref_raw_data)
    pretty_print_data(ref_parsed_data)
    sys.exit(0)

# Detect differences
parsed_data = {ref_raw_data: ref_parsed_data}
for raw_data in opts.data:
    data = list(raw_data)
    parsed_data[raw_data] = parse_sensors_data(raw_data)
    for idx, char in enumerate(ref_data):
        if char == data[idx]:
            continue
        DIFF[idx] = (DIFF[idx] + [data[idx]]) if idx in DIFF else [char, data[idx]]

    for k, v in ref_parsed_data.items():
        if parsed_data[raw_data][k] == v:
            continue
        DIFF_KEYS[k] = (
            (DIFF_KEYS[k] + [parsed_data[raw_data][k]])
            if k in DIFF_KEYS
            else [v, parsed_data[raw_data][k]]
        )

IDENTIFIED_POS_DIFF = [idx for idx in sorted(DIFF) if idx in IDENTIFIED_POS]
NON_IDENTIFIED_POS_DIFF = [idx for idx in sorted(DIFF) if idx not in IDENTIFIED_POS]

if IDENTIFIED_POS_DIFF:
    print(
        "Raw idendified position differences: "
        + ", ".join(
            [
                f"{idx} ({IDENTIFIED_POS[idx]}, {' => '.join(DIFF[idx])})"
                for idx in IDENTIFIED_POS_DIFF
            ]
        )
    )
if NON_IDENTIFIED_POS_DIFF:
    print(
        format_in_red(
            "Raw non-idendified position differences:\n"
            + "\n".join([f"- {idx} ({' => '.join(DIFF[idx])})" for idx in NON_IDENTIFIED_POS_DIFF])
        )
    )

print(
    "Keys differences:\n"
    + "\n".join(
        [
            f"- {key} ({' => '.join([str(value) for value in values])})"
            for key, values in DIFF_KEYS.items()
        ]
    )
)
print()

print(format_diff_data(ref_data))
pretty_print_data(parse_sensors_data(ref_raw_data))
print()

for raw_data in opts.data:
    print(format_diff_data(list(raw_data)))
    pretty_print_data(parse_sensors_data(raw_data))
    print()
